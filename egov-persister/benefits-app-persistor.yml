serviceMaps:
  serviceName: universal-benefits-application
  mappings:
    - version: 1.0
      description: Persists benefit application details in tables
      fromTopic: ubp-application-create
      isTransaction: true
      queryMaps:
        - query: INSERT INTO eg_ubp_application (id, tenant_id, application_number, individual_id, program_code, status, wf_status, additional_details, schema, order_id, transaction_id, submission_id, content_id, created_by, last_modified_by, created_time, last_modified_time) VALUES (?, ?, ?, ?, ?, ?, ?,  CAST(? AS JSONB), CAST(? AS JSONB), ?, ?, ?, ?, ?, ?, ?, ?)
          basePath: Application
          jsonMaps:
            - jsonPath: $.Application.id
            - jsonPath: $.Application.tenantId
            - jsonPath: $.Application.applicationNumber
            - jsonPath: $.Application.individualId
            - jsonPath: $.Application.programCode
            - jsonPath: $.Application.status
            - jsonPath: $.Application.wfStatus
            - jsonPath: $.Application.additionalDetails
            - jsonPath: $.Application.schema
            - jsonPath: $.Application.orderId
            - jsonPath: $.Application.transactionId
            - jsonPath: $.Application.submissionId
            - jsonPath: $.Application.contentId
            - jsonPath: $.Application.auditDetails.createdBy
            - jsonPath: $.Application.auditDetails.lastModifiedBy
            - jsonPath: $.Application.auditDetails.createdTime
            - jsonPath: $.Application.auditDetails.lastModifiedTime

        - query: INSERT INTO eg_ubp_applicant(id, application_id, student_name, father_name, samagra_id, school_name, school_address, school_address_district, current_class, previous_year_marks, student_type, aadhar_last_4_digits, caste, income, gender, age, disability) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          basePath: Application
          jsonMaps:
            - jsonPath: $.Application.applicant.id
            - jsonPath: $.Application.id
            - jsonPath: $.Application.applicant.studentName
            - jsonPath: $.Application.applicant.fatherName
            - jsonPath: $.Application.applicant.samagraId
            - jsonPath: $.Application.applicant.currentSchoolName
            - jsonPath: $.Application.applicant.currentSchoolAddress
            - jsonPath: $.Application.applicant.currentSchoolAddressDistrict
            - jsonPath: $.Application.applicant.currentClass
            - jsonPath: $.Application.applicant.previousYearMarks
            - jsonPath: $.Application.applicant.studentType
            - jsonPath: $.Application.applicant.aadharLast4Digits
            - jsonPath: $.Application.applicant.caste
            - jsonPath: $.Application.applicant.income
            - jsonPath: $.Application.applicant.gender
            - jsonPath: $.Application.applicant.age
            - jsonPath: $.Application.applicant.disability

        - query: INSERT INTO eg_ubp_application_documents(id, filestore_id, document_type, document_uid, status, application_id, additional_details, created_by, last_modified_by, created_time, last_modified_time) VALUES (?, ?, ?, ?, ?, ?, CAST(? AS JSONB), ?, ?, ?, ?)
          basePath: Application.documents.*
          jsonMaps:
            - jsonPath: $.Application.documents.*.id
            - jsonPath: $.Application.documents.*.fileStoreId
            - jsonPath: $.Application.documents.*.documentType
            - jsonPath: $.Application.documents.*.documentUid
            - jsonPath: $.Application.documents.*.status
            - jsonPath: $.Application.id
            - jsonPath: $.Application.documents.*.additionalDetails
            - jsonPath: $.Application.auditDetails.createdBy
            - jsonPath: $.Application.auditDetails.lastModifiedBy
            - jsonPath: $.Application.auditDetails.createdTime
            - jsonPath: $.Application.auditDetails.lastModifiedTime

    - version: 1.0
      description: Updates benefit application details in tables
      fromTopic: ubp-application-update
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET status = ?, wf_status = ?, additional_details = CAST(? AS JSONB), schema = CAST(? AS JSONB), order_id = ?, transaction_id = ?, submission_id = ?, content_id = ?, last_modified_by = ?, last_modified_time = ? WHERE id = ?
          basePath: Application
          jsonMaps:
            - jsonPath: $.Application.status
            - jsonPath: $.Application.wfStatus
            - jsonPath: $.Application.additionalDetails
            - jsonPath: $.Application.schema
            - jsonPath: $.Application.orderId
            - jsonPath: $.Application.transactionId
            - jsonPath: $.Application.submissionId
            - jsonPath: $.Application.contentId
            - jsonPath: $.Application.auditDetails.lastModifiedBy
            - jsonPath: $.Application.auditDetails.lastModifiedTime
            - jsonPath: $.Application.id

    - version: 1.0
      description: Updates benefit application status in tables
      fromTopic: ubp-application-updatestatus
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET wf_status = ?,status = ?,disbursal_log='' WHERE id = ?
          basePath: $
          jsonMaps:
            - jsonPath: $.status
            
            - jsonPath: $.status
            
            - jsonPath: $.applicationId

    - version: 1.0
      description: Updates batch id of application by direct disbursal
      fromTopic: ubp-application-updatebatchid
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET batch_id = ? WHERE id = ?
          basePath: $
          jsonMaps:
            - jsonPath: $.batch_id     
            - jsonPath: $.applicationId

    - version: 1.0
      description: Update status as Amount Credited of application by batch id
      fromTopic: ubp-application-updateStatusByBatchId
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET wf_status = 'AMOUNT RECEIVED',status = 'AMOUNT RECEIVED',disbursal_log='' WHERE batch_id = ?
          basePath: $
          jsonMaps:
            - jsonPath: $.batch_id

    - version: 1.0
      description: Update status as Amount RECEIVED with error log  of application by batch id
      fromTopic: ubp-application-updateStatusByBatchIdErrorLog
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET wf_status = 'ERROR IN TRANSFERRING AMOUNT', status = 'ERROR IN TRANSFERRING AMOUNT', disbursal_log='DISBURSAL STATUS NOT FOUND' WHERE batch_id = ?
          basePath: $
          jsonMaps:
            - jsonPath: $.batch_id
            
    - version: 1.0
      description: Updates log of application in tables
      fromTopic: ubp-application-updateApplicationLog
      isTransaction: true
      queryMaps:
        - query: UPDATE eg_ubp_application SET disbursal_log = ? WHERE id = ?
          basePath: $
          jsonMaps:
            - jsonPath: $.status
            
            - jsonPath: $.applicationId

    - version: 1.0
      description: Updates orderId of application in table
      fromTopic: ubp-application-updateApplicationOrderId
      isTransaction: true
      queryMaps:
       - query: UPDATE eg_ubp_application SET order_id =COALESCE(?) WHERE id = ?
         basePath: $
         jsonMaps:
         - jsonPath: $.orderId
         - jsonPath: $.applicationId
              
